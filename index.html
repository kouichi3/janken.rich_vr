<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width">
<script src="js/jquery-2.1.3.min.js"></script>
<link rel="stylesheet" href="style.css">
<title>ã˜ã‚ƒã‚“ã‘ã‚“</title>
</head>
<body>

<header>
  <h1>ã‚¹ã‚´ãƒ­ã‚¯ã˜ã‚ƒã‚“ã‘ã‚“</h1>
</header>

<main>

  <!-- èª¬æ˜ï¼‹å‹•ç”»ãƒ–ãƒ­ãƒƒã‚¯ -->
  <div class="intro-block">
    <h2>ã˜ã‚ƒã‚“ã‘ã‚“ã§éŠã¼ã†ï¼</h2>
    <div id="display_area">
      <!-- åˆæœŸè¡¨ç¤ºã¯å‹•ç”»ã ã‘ -->
      <video id="janken_movie" src="movie/janken2_movie.mp4" controls width="400"></video>
    </div>
  </div>

  <!-- â˜… ã“ã“ã«ã‚°ãƒªã‚³ã™ã”ã‚ãç›¤é¢ã¨çŠ¶æ³è¡¨ç¤ºã‚’è¿½åŠ  â˜… -->
  <div id="board" class="board"></div>

  <div class="info-area">
    <p id="position_info">ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼: 0ãƒã‚¹ / ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿ãƒ¼: 0ãƒã‚¹</p>
    <p id="log">å‹ã£ãŸæ–¹ã ã‘é€²ã‚€ã‚ˆï¼</p>
  </div>

  <!-- ã˜ã‚ƒã‚“ã‘ã‚“ã®çµæœè¡¨ç¤º -->
  <div class="result-area">
    <p id="pc_hands"></p>
    <p id="judgment"></p>
  </div>

  <!-- ã˜ã‚ƒã‚“ã‘ã‚“ãƒœã‚¿ãƒ³ -->
  <ul class="ur-box">
    <li id="gu_btn">ã‚°ãƒ¼</li>
    <li id="cho_btn">ãƒãƒ§ã‚­</li>
    <li id="par_btn">ãƒ‘ãƒ¼</li>
  </ul>

  <!-- ãƒªã‚»ãƒƒãƒˆãƒœã‚¿ãƒ³ï¼šå‹•ç”»ï¼‹ã™ã”ã‚ãã‚’æœ€åˆã«æˆ»ã™ï¼†æ¬¡ã®ã˜ã‚ƒã‚“ã‘ã‚“ãƒœã‚¿ãƒ³ -->
  <div class="reset-area">
    <button id="reset_btn">ãƒªã‚»ãƒƒãƒˆï¼ˆå…¨éƒ¨æœ€åˆã‹ã‚‰ï¼‰</button>
    <button id="next_btn">æ¬¡ã®ã˜ã‚ƒã‚“ã‘ã‚“ï¼ˆå‹•ç”»å†ç”Ÿï¼‰</button>
  </div>

</main>

<footer></footer>

<script>
$(function(){
  // =====================
  // ã™ã”ã‚ãç”¨ã®å¤‰æ•°ãƒ»é–¢æ•°
  // =====================
  var GOAL = 20;          // ã‚´ãƒ¼ãƒ«ãƒã‚¹
  var playerPos = 0;      // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ä½ç½®
  var cpuPos = 0;         // CPUã®ä½ç½®
  var isGameOver = false; // ã‚´ãƒ¼ãƒ«ã—ãŸã‚‰ true

  var lastPlayerHand = null; // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒç›´å‰ã«å‡ºã—ãŸæ‰‹
  var lastCpuHand = null;    // CPUãŒç›´å‰ã«å‡ºã—ãŸæ‰‹

  // æ‰‹ã”ã¨ã®é€²ã‚€ãƒã‚¹æ•°
  var handStepMap = {
    "gu": 1,
    "cho": 2,
    "par": 3
  };

  var handNameMap = {
    "gu": "ã‚°ãƒ¼",
    "cho": "ãƒãƒ§ã‚­",
    "par": "ãƒ‘ãƒ¼"
  };

  function getHandIcon(hand, who){
    if(hand === "gu") return "âœŠ";
    if(hand === "cho") return "âœŒï¸";
    if(hand === "par") return "âœ‹";
    // ã¾ã ä¸€åº¦ã‚‚å‡ºã—ã¦ã„ãªã„ã¨ãã®åˆæœŸã‚¢ã‚¤ã‚³ãƒ³
    if(who === "player") return "ğŸ‘¤";
    if(who === "cpu") return "ğŸ¤–";
    return "â—";
  }

  // ç›¤é¢ã‚’ä½œã‚‹
  function createBoard(){
    $("#board").empty();
    for(var i = 0; i <= GOAL; i++){
      var text = "";
      var extraClass = "";

      if(i === 0){
        text = "ã‚¹ã‚¿ãƒ¼ãƒˆ";
        extraClass = " start-cell";
      }else if(i === GOAL){
        text = "ã‚´ãƒ¼ãƒ«";
        extraClass = " goal-cell";
      }else{
        text = i;
        // äººç”Ÿã‚²ãƒ¼ãƒ ã£ã½ãã€ã¨ã“ã‚ã©ã“ã‚ã‚¤ãƒ™ãƒ³ãƒˆãƒã‚¹ã‚’ä»˜ã‘ã‚‹
        if(i % 5 === 0){
          extraClass = " event-cell";
        }
      }

      $("#board").append('<div class="cell'+ extraClass +'" data-index="'+i+'">'+ text +'</div>');
    }
  }

  // é§’ã®è¡¨ç¤ºã‚’æ›´æ–°
  function updateBoard(){
    $(".cell").removeClass("player cpu");
    $(".piece").remove(); // é§’ã‚¢ã‚¤ã‚³ãƒ³ã‚’ä¸€åº¦ã‚¯ãƒªã‚¢

    if(playerPos > GOAL) playerPos = GOAL;
    if(cpuPos > GOAL) cpuPos = GOAL;

    $('.cell[data-index="'+playerPos+'"]').addClass("player");
    $('.cell[data-index="'+cpuPos+'"]').addClass("cpu");

    // ãã‚Œãã‚Œã®é§’ã‚¢ã‚¤ã‚³ãƒ³ã‚’è¡¨ç¤º
    var playerIcon = getHandIcon(lastPlayerHand, "player");
    var cpuIcon = getHandIcon(lastCpuHand, "cpu");

    $('.cell[data-index="'+playerPos+'"]').append('<div class="piece player-piece">'+ playerIcon +'</div>');
    $('.cell[data-index="'+cpuPos+'"]').append('<div class="piece cpu-piece">'+ cpuIcon +'</div>');

    $("#position_info").text(
      "ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼: " + playerPos + "ãƒã‚¹ / ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿ãƒ¼: " + cpuPos + "ãƒã‚¹"
    );
  }

  // ã‚´ãƒ¼ãƒ«åˆ¤å®š
  function checkWinnerSugoroku(){
    if(playerPos >= GOAL && cpuPos >= GOAL){
      $("#log").text("åŒæ™‚ã«ã‚´ãƒ¼ãƒ«ï¼å¼•ãåˆ†ã‘ï¼");
      isGameOver = true;
    }else if(playerPos >= GOAL){
      $("#log").text("ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®å‹ã¡ï¼ï¼");
      isGameOver = true;
    }else if(cpuPos >= GOAL){
      $("#log").text("ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿ãƒ¼ã®å‹ã¡â€¦");
      isGameOver = true;
    }
  }

  // å‹ã£ãŸæ–¹ã ã‘é€²ã‚ã‚‹
  function moveWinner(winner, winnerHand){
    if(isGameOver) return; // ã‚‚ã†ã‚´ãƒ¼ãƒ«ã—ã¦ã„ãŸã‚‰å‹•ã‹ã•ãªã„

    if(winner === "none"){
      $("#log").text("ã‚ã„ã“ã§ã€èª°ã‚‚é€²ã¾ãªã„â€¦");
      return;
    }

    var step = handStepMap[winnerHand];

    if(winner === "player"){
      playerPos += step;
      $("#log").text("ã‚ãªãŸãŒ" + step + "ãƒã‚¹é€²ã‚“ã ï¼");
    }else if(winner === "cpu"){
      cpuPos += step;
      $("#log").text("ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿ãƒ¼ãŒ" + step + "ãƒã‚¹é€²ã‚“ã ï¼");
    }

    updateBoard();
    checkWinnerSugoroku();
  }

  // ã™ã”ã‚ãã®ãƒªã‚»ãƒƒãƒˆ
  function resetSugoroku(){
    playerPos = 0;
    cpuPos = 0;
    isGameOver = false;
    lastPlayerHand = null;
    lastCpuHand = null;
    $("#log").text("å‹ã£ãŸæ–¹ã ã‘é€²ã‚€ã‚ˆï¼");
    createBoard();
    updateBoard();
  }

  // r(1ã€œ3) ã‹ã‚‰CPUã®æ‰‹ã‚’æ±‚ã‚ã‚‹
  function cpuHandFromR(r){
    if(r === 1) return "gu";
    if(r === 2) return "cho";
    return "par";
  }

  // æœ€åˆã«ç›¤é¢ã‚’ä½œã£ã¦ãŠã
  resetSugoroku();

  // =====================
  // ã˜ã‚ƒã‚“ã‘ã‚“è¡¨ç¤ºå…±é€šé–¢æ•°
  // =====================
  function showResult(imgSrc, text) {
    // å‹•ç”»ãŒå…¥ã£ã¦ã„ãŸæ ã”ã¨ã€ç”»åƒã«ç½®ãæ›ãˆã‚‹
    $("#display_area").html('<img src="' + imgSrc + '" alt="' + text + '" width="400">');
    $("#judgment").text(text);
  }

  // =====================
  // ã˜ã‚ƒã‚“ã‘ã‚“ãƒœã‚¿ãƒ³
  // =====================
  // ã‚°ãƒ¼ãƒœã‚¿ãƒ³
  $("#gu_btn").on("click",function(){
    if(isGameOver) return; // ã‚´ãƒ¼ãƒ«å¾Œã¯å‹•ã‹ã•ãªã„

    const r = Math.ceil(Math.random()*3); // CPUã®æ‰‹
    var cpuHand = cpuHandFromR(r);
    var playerHand = "gu";

    lastPlayerHand = playerHand;
    lastCpuHand = cpuHand;

    if(r == 1){
        // CPU:ã‚°ãƒ¼ â†’ ã‚ã„ã“
        showResult("img/gu.png", "ã‚ã„ã“");
        moveWinner("none", playerHand);
    }
    if(r == 2){
        // CPU:ãƒãƒ§ã‚­ â†’ å‹ã¡
        showResult("img/tyoki.png", "å‹ã¡");
        moveWinner("player", playerHand);
    }
    if(r == 3){
        // CPU:ãƒ‘ãƒ¼ â†’ è² ã‘
        showResult("img/pa-.png", "è² ã‘");
        moveWinner("cpu", cpuHand);
    }
  });

  // ãƒãƒ§ã‚­ãƒœã‚¿ãƒ³
  $("#cho_btn").on("click",function(){
    if(isGameOver) return;

    const r = Math.ceil(Math.random()*3);
    var cpuHand = cpuHandFromR(r);
    var playerHand = "cho";

    lastPlayerHand = playerHand;
    lastCpuHand = cpuHand;

    if(r == 1){
        // CPU:ã‚°ãƒ¼ â†’ è² ã‘
        showResult("img/gu.png", "è² ã‘");
        moveWinner("cpu", cpuHand);
    }
    if(r == 2){
        // CPU:ãƒãƒ§ã‚­ â†’ ã‚ã„ã“
        showResult("img/tyoki.png", "ã‚ã„ã“");
        moveWinner("none", playerHand);
    }
    if(r == 3){
        // CPU:ãƒ‘ãƒ¼ â†’ å‹ã¡
        showResult("img/pa-.png", "å‹ã¡");
        moveWinner("player", playerHand);
    }
  });

  // ãƒ‘ãƒ¼ãƒœã‚¿ãƒ³
  $("#par_btn").on("click",function(){
    if(isGameOver) return;

    const r = Math.ceil(Math.random()*3);
    var cpuHand = cpuHandFromR(r);
    var playerHand = "par";

    lastPlayerHand = playerHand;
    lastCpuHand = cpuHand;

    if(r == 1){
        // CPU:ã‚°ãƒ¼ â†’ å‹ã¡
        showResult("img/tyoki.png", "è² ã‘");
        moveWinner("cpu", cpuHand);
    }
    if(r == 2){
        // CPU:ãƒãƒ§ã‚­ â†’ è² ã‘
        showResult("img/gu.png", "å‹ã¡");
        moveWinner("player", playerHand);
    }
    if(r == 3){
        // CPU:ãƒ‘ãƒ¼ â†’ ã‚ã„ã“
        showResult("img/pa-.png", "ã‚ã„ã“");
        moveWinner("none", playerHand);
    }
  });

  // =====================
  // ãƒªã‚»ãƒƒãƒˆãƒœã‚¿ãƒ³
  // =====================
  $("#reset_btn").on("click", function() {
    // â‘  display_area ã‚’å‹•ç”»ã«æˆ»ã™
    $("#display_area").html('<video id="janken2_movie" src="movie/janken2_movie.mp4" controls width="400"></video>');

    // â‘¡ å‹•ç”»ã‚’è‡ªå‹•å†ç”Ÿ
    const v = document.getElementById("janken2_movie");
    if (v) {
      v.play();
    }

    // â‘¢ å‹ã¡è² ã‘è¡¨ç¤ºã‚¯ãƒªã‚¢
    $("#judgment").text("");

    // â‘£ ã™ã”ã‚ãã‚‚ãƒªã‚»ãƒƒãƒˆ
    resetSugoroku();
  });

  $("#next_btn").on("click", function() {
    // å‹•ç”»ã‚’å·®ã—æ›¿ãˆã¦å†ç”Ÿã™ã‚‹ãŒã€ã™ã”ã‚ãã®ä½ç½®ã¯ãã®ã¾ã¾
    $("#display_area").html('<video id="janken2_movie" src="movie/janken2_movie.mp4" controls width="400"></video>');

    const v2 = document.getElementById("janken2_movie");
    if (v2) {
      v2.play();
    }

    // å‰å›ã®å‹æ•—ãƒ†ã‚­ã‚¹ãƒˆã ã‘æ¶ˆã—ã¦ãŠãï¼ˆãŠå¥½ã¿ï¼‰
    $("#judgment").text("");
  });

});
</script>
</body>
</html>
